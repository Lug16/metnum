<!DOCTYPE HTML>
<html>

<head>
  <script type="text/javascript" src="graph.js"></script>
  <script type="text/javascript" src="math.min.js"></script>
  <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML' async></script>
  <style>
    body {
        margin: 0px;
        padding: 0px;
      }

    </style>
</head>

<body>
  <div>
    <input id="equationInput" type="text" value="" placeholder="Inserte ecuacion (ejem: x^3-x-1)" />
    <button onclick="graphEquation()">Graficar</button>
    <br />
    <input id="seedInput" type="text" value="" placeholder="Punto Inicial" />
    <input id="errorInput" type="number" value="" placeholder="Error" />
  </div>
  <div style="display:flex; flex-direction: row">
    <canvas id="myCanvas" width="500" height="500"></canvas>
    <div style="display:flex; flex-direction:column">
      <p>
        Si \(f'(x_n) \ne 0\)
        $$x_{(n+1)}=x_n - {f(x_n) \over f'(x_n)}$$
      </p>

      <table style="border:1px solid black">
        <tr>
          <td>\(x_n\)</td>
          <td>1</td>
        </tr>
        <tr>
          <td>\(f(x_n)\)</td>
          <td>1</td>
        </tr>
        <tr>
          <td>\(f'(x_n)\)</td>
          <td>1</td>
        </tr>
        <tr>
          <td>\(x_{(n+1)}\)</td>
          <td>1</td>
        </tr>
        <tr>
          <td>\(E\)</td>
          <td>1</td>
        </tr>
      </table>
    </div>
  </div>
  <script>

    const conf = {
      canvasId: 'myCanvas',
      minX: -5,
      minY: -5,
      maxX: 5,
      maxY: 5,
      unitsPerTick: 1
    }

    function graphEquation() {
      const equation = math.parse(document.getElementById('equationInput').value);
      const seed = document.getElementById("seedInput").value;
      const error = Math.pow(10, -Math.abs(document.getElementById('errorInput').value));

      console.info(error);

      const myGraph = new Graph(conf);

      myGraph.drawEquation(function (x) {
        return equation.eval({ x });
      }, 'blue', 2);

      solveNewtonRaphson(equation, seed, error);
    }

    function solveNewtonRaphson(equation, seed, error) {
      let solution = {
        fields: [
          {
            "title": "x_n",
            "values": []
          },
          {
            "title": "f(x_n)",
            "values": []
          },
          {
            "title": "f'(x_n)",
            "values": []
          },
          {
            "title": "x_{(n+1)}",
            "values": []
          }
        ]
      }

      let currentError = 1;
      let x = parseInt(seed);
      let counter = 0;

      while (currentError > error) {
        const fx = equation.eval({ x });
        const dfx = math.derivative(equation, math.parse('x')).eval({ x });
        const y = x - fx / dfx;

        solution.fields[0].values.push(x);
        solution.fields[1].values.push(fx);
        solution.fields[2].values.push(dfx);
        solution.fields[3].values.push(y);

        currentError = counter > 0
          ? solution.fields[3].values[counter - 1] - y
          : 1;

        x = y;

        counter++;
      }

      console.info(solution);
    }
  </script>
</body>

</html>